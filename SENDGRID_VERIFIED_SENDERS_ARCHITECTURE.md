# SendGrid Verified Senders - Architecture & Flow Diagram\n\n## Architecture Overview\n\n```\n┌─────────────────────────────────────────────────────────────────────┐\n│                         API Endpoints                               │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  GET /api/v1/sender-emails/sendgrid/verified-sender                │\n│  └─ Returns: Single verified sender for authenticated user         │\n│                                                                     │\n│  GET /api/v1/sender-emails/sendgrid/verified-senders               │\n│  └─ Returns: All verified senders for authenticated user           │\n│                                                                     │\n│  GET /api/v1/sender-emails/sendgrid/all-verified-senders           │\n│  └─ Returns: All verified senders across all users (admin)         │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│                      Authentication Layer                           │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  Middleware: isAuthenticated                                        │\n│  ├─ Validates Bearer token                                          │\n│  ├─ Extracts user ID                                                │\n│  └─ Passes to controller                                            │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│                    Controller Layer                                 │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  getUserVerifiedSender()                                            │\n│  ├─ Checks authentication                                           │\n│  ├─ Calls service method                                            │\n│  └─ Returns single object or 404                                   │\n│                                                                     │\n│  getUserVerifiedSenders()                                           │\n│  ├─ Checks authentication                                           │\n│  ├─ Calls service method                                            │\n│  └─ Returns array of objects                                       │\n│                                                                     │\n│  getAllVerifiedSenders()                                            │\n│  ├─ Checks authentication                                           │\n│  ├─ Calls service method                                            │\n│  └─ Returns array of all objects                                   │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│                   Service Layer                                     │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  getUserVerifiedSender(userId)                                      │\n│  └─ SenderModel.findOne({                                           │\n│      user_id: userId,                                               │\n│      verified: true,                                                │\n│      type: 'sendgrid'                                               │\n│    })                                                                │\n│                                                                     │\n│  getUserVerifiedSenders(userId)                                     │\n│  └─ SenderModel.find({                                              │\n│      user_id: userId,                                               │\n│      verified: true,                                                │\n│      type: 'sendgrid'                                               │\n│    })                                                                │\n│                                                                     │\n│  getAllVerifiedSenders()                                            │\n│  └─ SenderModel.find({                                              │\n│      verified: true,                                                │\n│      type: 'sendgrid'                                               │\n│    })                                                                │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n                              ↓\n┌─────────────────────────────────────────────────────────────────────┐\n│                  MongoDB Database                                   │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  Collection: senderemails                                           │\n│  ┌──────────────────────────────────────────────────────────────┐  │\n│  │ {\n│  │   _id: ObjectId,                                             │  │\n│  │   senderName: \"John Doe\",                                   │  │\n│  │   senderEmail: \"john@example.com\",                          │  │\n│  │   user_id: ObjectId,                        [FILTERED BY]    │  │\n│  │   verified: true,                           [FILTERED BY]    │  │\n│  │   type: \"sendgrid\",                         [FILTERED BY]    │  │\n│  │   sendgridId: \"sg-sender-123\",                              │  │\n│  │   createdAt: Date,                                           │  │\n│  │   updatedAt: Date                                            │  │\n│  │ }                                                            │  │\n│  └──────────────────────────────────────────────────────────────┘  │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## Request Flow Diagram\n\n### Endpoint 1: Get User's Verified Senders\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│ 1. Client Request                                               │\n├─────────────────────────────────────────────────────────────────┤\n│ GET /api/v1/sender-emails/sendgrid/verified-senders            │\n│ Headers: Authorization: Bearer {token}                          │\n└─────────────────────────────────────────────────────────────────┘\n                         ↓\n┌─────────────────────────────────────────────────────────────────┐\n│ 2. Authentication Middleware                                    │\n├─────────────────────────────────────────────────────────────────┤\n│ isAuthenticated()                                               │\n│ ├─ Validates Bearer token                                       │\n│ ├─ Extracts user._id                                            │\n│ └─ ✅ Passes to next middleware/controller                      │\n└─────────────────────────────────────────────────────────────────┘\n                         ↓\n┌─────────────────────────────────────────────────────────────────┐\n│ 3. Controller Method                                            │\n├─────────────────────────────────────────────────────────────────┤\n│ getUserVerifiedSenders(req, res, next)                          │\n│ ├─ Extract userId from req.user._id                             │\n│ ├─ Call senderEmailService.getUserVerifiedSenders()             │\n│ └─ Send response                                                │\n└─────────────────────────────────────────────────────────────────┘\n                         ↓\n┌─────────────────────────────────────────────────────────────────┐\n│ 4. Service Method                                               │\n├─────────────────────────────────────────────────────────────────┤\n│ async getUserVerifiedSenders(userId)                            │\n│ ├─ Try block:                                                   │\n│ │  ├─ Query: SenderModel.find({                                 │\n│ │  │   user_id: userId,                                         │\n│ │  │   verified: true,                                          │\n│ │  │   type: 'sendgrid'                                         │\n│ │  │ })                                                         │\n│ │  └─ Return result array                                       │\n│ └─ Catch block:                                                 │\n│    ├─ Log error                                                 │\n│    └─ Return empty array                                        │\n└─────────────────────────────────────────────────────────────────┘\n                         ↓\n┌─────────────────────────────────────────────────────────────────┐\n│ 5. Database Query                                               │\n├─────────────────────────────────────────────────────────────────┤\n│ MongoDB Collection: senderemails                                │\n│ Filter: { user_id: uid, verified: true, type: 'sendgrid' }    │\n│ ├─ Find matching documents                                      │\n│ ├─ Return array of matches (0 or more)                          │\n│ └─ ✅ Minimal latency with indexes                              │\n└─────────────────────────────────────────────────────────────────┘\n                         ↓\n┌─────────────────────────────────────────────────────────────────┐\n│ 6. Response to Client                                           │\n├─────────────────────────────────────────────────────────────────┤\n│ HTTP 200 OK                                                     │\n│ {                                                               │\n│   \"error\": false,                                               │\n│   \"message\": \"Found 2 verified sender(s)\",                     │\n│   \"data\": [                                                     │\n│     {                                                           │\n│       \"_id\": \"...\",                                             │\n│       \"senderName\": \"John Doe\",                                │\n│       \"senderEmail\": \"john@example.com\",                      │\n│       \"verified\": true,                                         │\n│       \"type\": \"sendgrid\",                                       │\n│       \"sendgridId\": \"sg-123\"                                    │\n│     },                                                          │\n│     { ... }                                                     │\n│   ],                                                            │\n│   \"count\": 2                                                    │\n│ }                                                               │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## Data Flow Diagram\n\n```\n┌──────────────────────────────────────────────────────────────────────┐\n│                        Client Application                           │\n│  (UI, Mobile App, Third-party Service)                             │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↕\n                         (HTTP Requests/Responses)\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                       Route Handler                                 │\n│  GET /api/v1/sender-emails/sendgrid/verified-senders               │\n│  • Validates route                                                  │\n│  • Routes to controller method                                      │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                   Authentication Middleware                         │\n│  • Extracts Bearer token from Authorization header                 │\n│  • Validates token (JWT, session, etc.)                            │\n│  • Attaches user object to request (req.user)                      │\n│  • Throws 401 if invalid                                            │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                  Controller (Request Handler)                       │\n│  getUserVerifiedSenders(req, res, next) {                          │\n│    • Extract userId from req.user._id                              │\n│    • Validate userId exists                                         │\n│    • Call service method                                            │\n│    • Send JSON response                                             │\n│  }                                                                   │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                   Service Layer (Business Logic)                    │\n│  async getUserVerifiedSenders(userId) {                            │\n│    try {                                                            │\n│      const senders = await SenderModel.find({                      │\n│        user_id: userId,                                             │\n│        verified: true,                                              │\n│        type: 'sendgrid'                                             │\n│      })                                                              │\n│      return senders || []                                            │\n│    } catch(err) {                                                   │\n│      console.error(...)                                             │\n│      return []                                                       │\n│    }                                                                 │\n│  }                                                                   │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│              Data Access Layer (Mongoose/MongoDB)                   │\n│  SenderModel.find({                                                │\n│    user_id: ObjectId(\"507f...\"),                                   │\n│    verified: true,                                                  │\n│    type: 'sendgrid'                                                │\n│  })                                                                  │\n│  ✓ Filters on user_id (User isolation)                             │\n│  ✓ Filters on verified (Only successful senders)                   │\n│  ✓ Filters on type (Only SendGrid type)                            │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                   MongoDB Database                                  │\n│  Collection: senderemails                                          │\n│                                                                      │\n│  Query Result:                                                      │\n│  ┌────────────────────────────────────────────────────────────────┐  │\n│  │ [{                                                             │  │\n│  │   _id: ObjectId(\"507f...\"),                                   │  │\n│  │   senderName: \"John Doe\",                                    │  │\n│  │   senderEmail: \"john@example.com\",                          │  │\n│  │   user_id: ObjectId(\"507f...\"),                             │  │\n│  │   verified: true,                 ← Filter matches           │  │\n│  │   type: \"sendgrid\",               ← Filter matches           │  │\n│  │   sendgridId: \"sg-123456\",                                   │  │\n│  │   createdAt: ISODate(...),                                   │  │\n│  │   updatedAt: ISODate(...)                                    │  │\n│  │ }, {                                                          │  │\n│  │   ... another verified sender ...                             │  │\n│  │ }]                                                            │  │\n│  └────────────────────────────────────────────────────────────────┘  │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                   Return to Service Layer                           │\n│  Promise<Array<SenderEmailModel>>                                  │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│              Format Response in Controller                          │\n│  {                                                                  │\n│    error: false,                                                    │\n│    message: 'Found 2 verified sender(s)',                          │\n│    data: [sender1, sender2],                                       │\n│    count: 2                                                         │\n│  }                                                                   │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│            Send HTTP Response to Client                             │\n│  HTTP 200 OK                                                        │\n│  Content-Type: application/json                                    │\n│  { error: false, message: \"...\", data: [...], count: 2 }          │\n└──────────────────────────────────────────────────────────────────────┘\n                                 ↓\n┌──────────────────────────────────────────────────────────────────────┐\n│                 Client Receives Response                            │\n│  • Parse JSON response                                              │\n│  • Check error flag (false = success)                               │\n│  • Access data array                                                │\n│  • Use verified senders for campaigns, dropdowns, etc.             │\n└──────────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## Filter Logic Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│              Database Contains All Senders                      │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  [1] John Doe (SendGrid, Verified=true, user_id=A)    ✅       │\n│  [2] Jane Smith (SendGrid, Verified=false, user_id=A) ❌       │\n│  [3] Support (SendGrid, Verified=true, user_id=B)     ✅       │\n│  [4] Newsletter (Resend, Verified=true, user_id=A)    ❌       │\n│  [5] Marketing (SendGrid, Verified=true, user_id=A)   ✅       │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n                           ↓\n              Filter: type = 'sendgrid'\n                           ↓\n┌─────────────────────────────────────────────────────────────────┐\n│              After Type Filter                                 │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  [1] John Doe (verified=true, user_id=A)              ✅       │\n│  [2] Jane Smith (verified=false, user_id=A)           ❌       │\n│  [3] Support (verified=true, user_id=B)               ✅       │\n│  [4] Newsletter (REMOVED - type is Resend)                    │\n│  [5] Marketing (verified=true, user_id=A)             ✅       │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n                           ↓\n           Filter: verified = true\n                           ↓\n┌─────────────────────────────────────────────────────────────────┐\n│            After Verified Filter                               │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  [1] John Doe (user_id=A)                             ✅       │\n│  [2] Jane Smith (REMOVED - verified=false)                    │\n│  [3] Support (user_id=B)                              ✅       │\n│  [4] Newsletter (REMOVED earlier)                             │\n│  [5] Marketing (user_id=A)                            ✅       │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n                           ↓\n         Filter: user_id = A (for per-user endpoint)\n                           ↓\n┌─────────────────────────────────────────────────────────────────┐\n│          Final Result for User A                               │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  [1] John Doe                                         ✅       │\n│  [2] Jane Smith (REMOVED by verified filter)                  │\n│  [3] Support (REMOVED - user_id=B)                           │\n│  [4] Newsletter (REMOVED by type filter)                      │\n│  [5] Marketing                                        ✅       │\n│                                                                 │\n│  COUNT: 2 verified SendGrid senders for User A                │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## Response Time Flow\n\n```\nClient                          Server\n  |                                |\n  |--- 1. HTTP Request (Get) ---→ | 100ms (Network)\n  |     Bearer Token               |\n  |                                | 5ms (Route matching)\n  |                                | 5ms (Auth middleware)\n  |                                |\n  |                                | 50ms (Controller setup)\n  |                                |\n  |                                | 30ms (Service method)\n  |                                |\n  |                                | 10ms (DB Query)\n  |                                |   • Fetch from index\n  |                                |   • Deserialize docs\n  |                                |\n  |                                | 20ms (Response formatting)\n  |                                |\n  |← 2. HTTP Response (JSON) ---- | 100ms (Network)\n  |     200 OK + Data              |\n  |                                |\n  Total Round Trip: ~320ms\n```\n\n---\n\n## Error Handling Flow\n\n```\n┌─────────────────────────────────┐\n│  Request Arrives                │\n└──────────────┬──────────────────┘\n               ↓\n┌─────────────────────────────────┐\n│  Auth Check                     │\n│  └─ Valid token?                │\n├─────────────────────────────────┤\n│  NO → 401 Unauthorized          │ (Authentication failed)\n│  YES ↓                          │\n└──────────────┬──────────────────┘\n               ↓\n┌─────────────────────────────────┐\n│  Extract User ID                │\n│  └─ userId exists?              │\n├─────────────────────────────────┤\n│  NO → 400 Bad Request           │ (Invalid token data)\n│  YES ↓                          │\n└──────────────┬──────────────────┘\n               ↓\n┌─────────────────────────────────┐\n│  Call Service Method            │\n│  └─ Try-catch block             │\n├─────────────────────────────────┤\n│  ERROR → Log & Return []        │ (Service error, empty array)\n│  SUCCESS ↓                      │\n└──────────────┬──────────────────┘\n               ↓\n┌─────────────────────────────────┐\n│  Format Response                │\n│  └─ Build JSON response         │\n├─────────────────────────────────┤\n│  SUCCESS → 200 OK + Data        │ (Return verified senders)\n│  EMPTY → 200 OK + []            │ (No senders found, not an error)\n└─────────────────────────────────┘\n```\n\n---\n\n## Summary\n\nThe implementation follows a clean, layered architecture:\n\n1. **Routes** - Handle HTTP endpoints and middleware\n2. **Controllers** - Parse requests and coordinate responses\n3. **Services** - Contain business logic and database queries\n4. **Models** - Define data structures and interact with MongoDB\n5. **Database** - Stores and filters verified senders\n\nEach layer has clear separation of concerns and comprehensive error handling!\n