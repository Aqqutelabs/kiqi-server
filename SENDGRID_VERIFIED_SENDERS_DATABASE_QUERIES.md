# SendGrid Verified Senders - Database Queries Reference\n\n## MongoDB Queries\n\nUnderstanding the exact database queries used by the new endpoints:\n\n---\n\n## Query 1: Get User's Single Verified Sender\n\n### Service Method\n```typescript\ngetUserVerifiedSender(userId: string): Promise<SenderEmailModel | null>\n```\n\n### MongoDB Query\n```javascript\ndb.senderemails.findOne({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n\n### What It Does\n- Finds ONE document matching all criteria\n- Returns first match or null\n- Filters:\n  - `user_id` - Ensures user isolation\n  - `verified: true` - Only successful senders\n  - `type: \"sendgrid\"` - Only SendGrid senders\n\n### Response\n```json\n{\n  \"_id\": \"507f1f77bcf86cd799439011\",\n  \"senderName\": \"John Doe\",\n  \"senderEmail\": \"john@example.com\",\n  \"user_id\": \"507f1f77bcf86cd799439012\",\n  \"verified\": true,\n  \"sendgridId\": \"sg-sender-123456\",\n  \"type\": \"sendgrid\",\n  \"createdAt\": \"2024-01-30T10:00:00Z\",\n  \"updatedAt\": \"2024-01-30T10:05:00Z\"\n}\n```\n\n---\n\n## Query 2: Get All User's Verified Senders\n\n### Service Method\n```typescript\ngetUserVerifiedSenders(userId: string): Promise<SenderEmailModel[]>\n```\n\n### MongoDB Query\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n\n### What It Does\n- Finds ALL documents matching criteria\n- Returns array of matches (empty array if none found)\n- Filters:\n  - `user_id` - Ensures user isolation\n  - `verified: true` - Only successful senders\n  - `type: \"sendgrid\"` - Only SendGrid senders\n\n### Response\n```json\n[\n  {\n    \"_id\": \"507f1f77bcf86cd799439011\",\n    \"senderName\": \"John Doe\",\n    \"senderEmail\": \"john@example.com\",\n    \"verified\": true,\n    \"sendgridId\": \"sg-sender-123456\"\n  },\n  {\n    \"_id\": \"507f1f77bcf86cd799439013\",\n    \"senderName\": \"Business\",\n    \"senderEmail\": \"business@example.com\",\n    \"verified\": true,\n    \"sendgridId\": \"sg-sender-789012\"\n  }\n]\n```\n\n---\n\n## Query 3: Get All Verified Senders (System-wide)\n\n### Service Method\n```typescript\ngetAllVerifiedSenders(): Promise<SenderEmailModel[]>\n```\n\n### MongoDB Query\n```javascript\ndb.senderemails.find({\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n\n### What It Does\n- Finds ALL verified senders across all users\n- Returns array of matches\n- Filters:\n  - `verified: true` - Only successful senders\n  - `type: \"sendgrid\"` - Only SendGrid senders\n  - **NO user_id filter** - Returns all users' senders\n\n### Response\n```json\n[\n  {\n    \"_id\": \"507f1f77bcf86cd799439011\",\n    \"senderName\": \"John Doe\",\n    \"senderEmail\": \"john@example.com\",\n    \"user_id\": \"507f1f77bcf86cd799439012\",\n    \"verified\": true,\n    \"sendgridId\": \"sg-sender-123456\"\n  },\n  {\n    \"_id\": \"507f1f77bcf86cd799439013\",\n    \"senderName\": \"Jane Smith\",\n    \"senderEmail\": \"jane@example.com\",\n    \"user_id\": \"507f1f77bcf86cd799439015\",\n    \"verified\": true,\n    \"sendgridId\": \"sg-sender-789012\"\n  }\n]\n```\n\n---\n\n## Query Comparison\n\n| Query | Method | Filters | Returns | Use Case |\n|-------|--------|---------|---------|----------|\n| 1 | `findOne()` | user_id, verified, type | Single object or null | Get default sender |\n| 2 | `find()` | user_id, verified, type | Array of objects | List user's senders |\n| 3 | `find()` | verified, type only | Array of objects | List all senders (admin) |\n\n---\n\n## Filter Conditions Explained\n\n### verified: true\n- **Purpose:** Only return successfully verified senders\n- **Excludes:** Failed verifications, pending verifications\n- **Database field:** Boolean, set to true when verified in SendGrid\n\n### type: \"sendgrid\"\n- **Purpose:** Only return SendGrid type senders\n- **Excludes:** Other email providers (e.g., Resend, Custom)\n- **Database field:** String enum value\n- **Possible values:** \"sendgrid\", \"resend\", \"custom\", etc.\n\n### user_id (for per-user queries)\n- **Purpose:** User isolation - only show senders for that specific user\n- **Database field:** MongoDB ObjectId, references User collection\n- **Required in:** Query 1 and Query 2\n- **Omitted in:** Query 3 (admin endpoint shows all users)\n\n---\n\n## Indexes for Performance\n\nFor optimal query performance, ensure these indexes exist:\n\n```javascript\n// Index 1: For single user verified sender lookups\ndb.senderemails.createIndex({\n  user_id: 1,\n  verified: 1,\n  type: 1\n})\n\n// Index 2: For all verified senders lookup\ndb.senderemails.createIndex({\n  verified: 1,\n  type: 1\n})\n```\n\n---\n\n## Sample Database State\n\n### Collection: senderemails\n\n```javascript\n[\n  {\n    \"_id\": ObjectId(\"507f1f77bcf86cd799439011\"),\n    \"senderName\": \"John Doe\",\n    \"senderEmail\": \"john@example.com\",\n    \"user_id\": ObjectId(\"507f1f77bcf86cd799439012\"),\n    \"verified\": true,              // ✅ Matches filter\n    \"type\": \"sendgrid\",             // ✅ Matches filter\n    \"sendgridId\": \"sg-sender-123456\",\n    \"createdAt\": \"2024-01-30T10:00:00Z\",\n    \"updatedAt\": \"2024-01-30T10:05:00Z\"\n  },\n  {\n    \"_id\": ObjectId(\"507f1f77bcf86cd799439013\"),\n    \"senderName\": \"Jane Smith\",\n    \"senderEmail\": \"jane@example.com\",\n    \"user_id\": ObjectId(\"507f1f77bcf86cd799439012\"),\n    \"verified\": false,             // ❌ Does NOT match (pending)\n    \"type\": \"sendgrid\",\n    \"sendgridId\": \"sg-sender-789012\",\n    \"createdAt\": \"2024-01-28T15:00:00Z\"\n  },\n  {\n    \"_id\": ObjectId(\"507f1f77bcf86cd799439014\"),\n    \"senderName\": \"Support Team\",\n    \"senderEmail\": \"support@example.com\",\n    \"user_id\": ObjectId(\"507f1f77bcf86cd799439015\"),\n    \"verified\": true,              // ✅ Matches filter\n    \"type\": \"sendgrid\",             // ✅ Matches filter\n    \"sendgridId\": \"sg-sender-345678\",\n    \"createdAt\": \"2024-01-25T12:00:00Z\",\n    \"updatedAt\": \"2024-01-26T09:00:00Z\"\n  },\n  {\n    \"_id\": ObjectId(\"507f1f77bcf86cd799439015\"),\n    \"senderName\": \"Newsletter\",\n    \"senderEmail\": \"newsletter@example.com\",\n    \"user_id\": ObjectId(\"507f1f77bcf86cd799439012\"),\n    \"verified\": true,              // ✅ Matches filter\n    \"type\": \"resend\",               // ❌ Does NOT match (different type)\n    \"sendgridId\": null,\n    \"createdAt\": \"2024-01-20T08:00:00Z\",\n    \"updatedAt\": \"2024-01-21T14:00:00Z\"\n  }\n]\n```\n\n### Query Results for User 507f1f77bcf86cd799439012\n\n#### Query 1: findOne with user_id filter\n```javascript\ndb.senderemails.findOne({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n**Result:** Returns document #1 (John Doe) - first match\n\n#### Query 2: find with user_id filter\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n**Result:** Returns documents #1 (John Doe) only\n- Document #2 (Jane) excluded - verified: false\n- Document #4 (Newsletter) excluded - type: \"resend\"\n\n#### Query 3: find without user_id filter\n```javascript\ndb.senderemails.find({\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n**Result:** Returns documents #1 and #3\n- John Doe (user 507f1f77bcf86cd799439012)\n- Support Team (user 507f1f77bcf86cd799439015)\n\n---\n\n## Debugging Queries\n\n### Check All Senders in Database\n```javascript\ndb.senderemails.find()\n```\n\n### Check Verified SendGrid Senders\n```javascript\ndb.senderemails.find({\n  verified: true,\n  type: \"sendgrid\"\n})\n```\n\n### Check User's All Senders (Regardless of Status)\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\")\n})\n```\n\n### Check Pending Verifications for a User\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: false,\n  type: \"sendgrid\"\n})\n```\n\n### Count Verified Senders by Type\n```javascript\ndb.senderemails.aggregate([\n  { $match: { verified: true } },\n  { $group: { _id: \"$type\", count: { $sum: 1 } } }\n])\n```\n\n---\n\n## Mongoose Implementation Details\n\n### In senderEmail.service.impl.ts\n\n```typescript\n// The actual Mongoose calls used:\n\n// Query 1: Single sender\nconst sender = await SenderModel.findOne({ \n  user_id: userId,\n  verified: true, \n  type: 'sendgrid' \n});\n\n// Query 2: Multiple senders\nconst senders = await SenderModel.find({ \n  user_id: userId,\n  verified: true,\n  type: 'sendgrid'\n});\n\n// Query 3: All senders\nconst senders = await SenderModel.find({ \n  verified: true,\n  type: 'sendgrid'\n});\n```\n\n---\n\n## Performance Considerations\n\n### Query Complexity\n- All queries use simple equality filters\n- No aggregations or complex logic\n- O(n) complexity where n = matching documents\n\n### Optimization Tips\n1. **Add Indexes** - Create indexes for filtered fields\n2. **Pagination** - Add skip/limit for large result sets\n3. **Projection** - Only select needed fields:\n   ```typescript\n   SenderModel.find({...}).select('_id senderName senderEmail sendgridId')\n   ```\n4. **Caching** - Cache frequently accessed verified senders\n\n### Example with Optimization\n```typescript\n// Optimized query with projection and pagination\nconst senders = await SenderModel.find({ \n  user_id: userId,\n  verified: true,\n  type: 'sendgrid'\n})\n.select('_id senderName senderEmail sendgridId type verified')\n.skip(skip)\n.limit(limit)\n.lean(); // Return plain JS objects instead of Mongoose documents\n```\n\n---\n\n## Related Queries\n\n### Query to find unverified senders\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: false,\n  type: \"sendgrid\"\n})\n```\n\n### Query to find all SendGrid senders (verified + unverified)\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  type: \"sendgrid\"\n})\n```\n\n### Query to find all verified senders (any type)\n```javascript\ndb.senderemails.find({\n  user_id: ObjectId(\"507f1f77bcf86cd799439012\"),\n  verified: true\n})\n```\n\n---\n\n## Database Schema\n\n### SenderEmail Collection\n```typescript\ninterface SenderEmailModel extends Document {\n  _id: string;\n  senderName: string;           // Human-readable name\n  type: string;                  // \"sendgrid\", \"resend\", etc.\n  senderEmail: string;           // Email address\n  user_id?: ObjectId;            // Reference to User document\n  verified?: boolean;            // true = SendGrid verified\n  verificationCode?: string;     // Verification token\n  verificationExpires?: Date;    // Token expiration\n  createdAt?: Date;\n  updatedAt?: Date;\n  sendgridId?: string;           // SendGrid's sender ID\n}\n```\n\n---\n\n## Summary\n\nThe three endpoints use simple, efficient MongoDB queries:\n\n1. **User's Single Sender** - `findOne()` with 3 filters\n2. **User's All Senders** - `find()` with 3 filters\n3. **System All Senders** - `find()` with 2 filters (no user_id)\n\nAll queries are optimized for:\n- ✅ User isolation (filters by user_id)\n- ✅ Verified-only results (filters by verified: true)\n- ✅ SendGrid type only (filters by type: \"sendgrid\")\n- ✅ Fast retrieval (simple equality filters, no complex logic)\n